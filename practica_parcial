package juego;
import java.util.List;
import java.util.ArrayList;

public class BattleArena {
    // PREGUNTA 1: Â¿QuÃ© tipo de variable debe ser battleActive y por quÃ©?
    private volatile boolean battleActive = false;
    
    private int totalDamageDealt = 0;
    private final List<Warrior> warriors = new ArrayList<>();
    
    // PREGUNTA 2: Â¿QuÃ© monitores especÃ­ficos necesitamos?
    private final Object damageLock = new Object();  // Para el daÃ±o total
    private final Object warriorsLock = new Object(); // Para la lista de guerreros
    
    public static void main(String[] args) throws InterruptedException {
        BattleArena arena = new BattleArena();
        arena.startBattle();
        Thread.sleep(8000); // Esperar 8 segundos
    }
    
    // PREGUNTA 3: Â¿Debe ser sincronizado este mÃ©todo? Â¿Por quÃ©?
    public synchronized void startBattle() {
        battleActive = true;
        System.out.println("âš”ï¸ Â¡La batalla ha comenzado!");
        
        // Crear hilos de guerreros
        for (int i = 0; i < 4; i++) {
            Warrior warrior = new Warrior("Warrior_" + i, this);
            
            // PREGUNTA 4: Complete la sincronizaciÃ³n para agregar guerreros
            synchronized (warriorsLock) {
                warriors.add(warrior);
                warriorsLock.notifyAll();
                System.out.println("ğŸ›¡ï¸ " + warrior.getName() + " se uniÃ³ a la batalla");
            }
            
            new Thread(warrior::fight, "Fighter_" + i).start();
        }
        
        // Iniciar hilo observador
        new Thread(this::battleObserver, "Observer").start();
    }
    
    public void dealDamage(int damage, String attackerName) {
        // PREGUNTA 5: Implemente usando candado implÃ­cito para totalDamageDealt
        synchronized (damageLock) {
            totalDamageDealt += damage;
            System.out.println("ğŸ’¥ " + attackerName + " causÃ³ " + damage + 
                             " de daÃ±o (Total: " + totalDamageDealt + ")");
            
            // Si el daÃ±o total supera 150, terminar batalla
            if (totalDamageDealt >= 150) {
                battleActive = false;
                System.out.println("ğŸ† Â¡Batalla terminada! DaÃ±o total: " + totalDamageDealt);
                
                // Notificar a observadores
                damageLock.notifyAll(); // Despertar hilos esperando
            }
        }
    }
    
    /**
     * Observador que usa wait/notify pattern
     */
    private void battleObserver() {
        try {
            synchronized (damageLock) {
                while (battleActive && totalDamageDealt < 150) {
                    System.out.println("ğŸ‘ï¸ Observador esperando... (DaÃ±o actual: " + totalDamageDealt + ")");
                    damageLock.wait(3000); // Esperar mÃ¡ximo 3 segundos
                }
            }
            System.out.println("ğŸ‘ï¸ Observador: La batalla ha terminado!");
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    public boolean isBattleActive() {
        return battleActive; // Variable volÃ¡til
    }
    
    public int getWarriorCount() {
        synchronized (warriorsLock) {
            return warriors.size();
        }
    }
    
    public int getTotalDamage() {
        synchronized (damageLock) {
            return totalDamageDealt;
        }
    }
}

class Warrior {
    private final String name;
    private final BattleArena arena;
    private int damageDealt = 0;
    
    public Warrior(String name, BattleArena arena) {
        this.name = name;
        this.arena = arena;
    }
    
    public void fight() {
        while (arena.isBattleActive()) {
            try {
                int damage = (int)(Math.random() * 25) + 5; // 5-30 daÃ±o
                arena.dealDamage(damage, name);
                damageDealt += damage;
                
                Thread.sleep(800 + (int)(Math.random() * 1200)); // 0.8-2.0 segundos
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
        System.out.println("âš¡ " + name + " terminÃ³ la batalla (DaÃ±o total: " + damageDealt + ")");
    }
    
    public String getName() {
        return name;
    }
}
